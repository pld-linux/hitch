# Fixes a bug in the test suite that leaves running processes behind

diff -Nur tests.orig/common.sh tests/common.sh
--- tests.orig/common.sh	2015-06-18 12:01:42.000000000 +0200
+++ tests/common.sh	2015-06-25 11:42:43.073934674 +0200
@@ -7,13 +7,14 @@
 PIDFILE="$(mktemp -u)"
 CONFFILE="$(mktemp -u)"
 DUMPFILE="$(mktemp -u)"
+SESSFILE="$(mktemp)"
 
 HITCH=../src/hitch-openssl
 HITCH_ARGS="--pidfile=$PIDFILE --daemon --quiet"
 
 cleanup() {
         test -s $PIDFILE && kill `cat "$PIDFILE"`
-        rm -f "$PIDFILE" "$CONFFILE" "$DUMPFILE" 2>/dev/null
+        rm -f "$PIDFILE" "$CONFFILE" "$DUMPFILE" "$SESSFILE" 2>/dev/null
 }
 trap cleanup EXIT
 
diff -Nur tests.orig/test06-ticket-resume tests/test06-ticket-resume
--- tests.orig/test06-ticket-resume	2015-06-25 11:33:22.324599585 +0200
+++ tests/test06-ticket-resume	2015-06-25 11:43:13.974677607 +0200
@@ -5,19 +5,13 @@
 . common.sh
 set +o errexit
 
-sessfile=$(mktemp)
-function rmsess {
-	rm -f $sessfile
-}
-trap rmsess EXIT
-
 $HITCH $HITCH_ARGS --backend=[hyse.org]:80 "--frontend=[${LISTENADDR}]:$LISTENPORT" certs/site1.example.com
 test "$?" = "0" || die "Hitch did not start."
 
-echo -e "\n" | openssl s_client -prexit -sess_out $sessfile -connect $LISTENADDR:$LISTENPORT >/dev/null 2>&1
+echo -e "\n" | openssl s_client -prexit -sess_out $SESSFILE -connect $LISTENADDR:$LISTENPORT >/dev/null 2>&1
 test "$?" = "0" || die "s_client failed (1)"
 
-echo -e "\n" | openssl s_client -prexit -sess_in $sessfile -connect $LISTENADDR:$LISTENPORT 2>/dev/null > $DUMPFILE
+echo -e "\n" | openssl s_client -prexit -sess_in $SESSFILE -connect $LISTENADDR:$LISTENPORT 2>/dev/null > $DUMPFILE
 test "$?" = "0" || die "s_client failed (2)"
 
 grep -q -c "Reused, " $DUMPFILE
